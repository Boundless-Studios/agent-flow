{% extends "layout.html" %}

{% block content %}
  <div class="grid">
    <section class="card" id="sessions-section" data-refresh-url="/partials/sessions">
      <div class="card-header">
        <h2>Sessions</h2>
      </div>

      {% if sessions %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Session ID</th>
                <th>State</th>
                <th>Last Seen</th>
                <th>Pending</th>
              </tr>
            </thead>
            <tbody>
              {% for session in sessions %}
                <tr>
                  <td>{{ session.display_name }}</td>
                  <td><code>{{ session.session_id }}</code></td>
                  <td>
                    <span class="state state-{{ session.state.value|lower }}">{{ session.state.value }}</span>
                    {% if session.response_acknowledged %}
                      <span class="state state-ack">ACK</span>
                    {% endif %}
                  </td>
                  <td>{{ session.last_seen_at.strftime('%Y-%m-%d %H:%M:%S %Z') }}</td>
                  <td>{{ session.pending_request_count }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="empty">No sessions registered yet.</p>
      {% endif %}
    </section>

    <section class="card" id="requests-section" data-refresh-url="/partials/requests">
      <div class="card-header">
        <h2>Pending Input Requests</h2>
        <div class="notify-controls">
          <button type="button" class="notifications-enable" data-enable-notifications hidden>
            Enable Desktop Notifications
          </button>
          <span class="notifications-state" data-notification-state></span>
        </div>
      </div>

      {% if pending_requests %}
        <ul class="request-list">
          {% for request_obj in pending_requests %}
            <li class="request-item" data-request-id="{{ request_obj.request_id }}">
              <details class="request-entry">
                <summary>
                  <span class="title">{{ request_obj.title }}</span>
                  <span class="meta">
                    <span class="priority priority-{{ request_obj.priority.value|lower }}">{{ request_obj.priority.value }}</span>
                    <span><code>{{ request_obj.session_id }}</code></span>
                  </span>
                  <div class="question">{{ request_obj.question }}</div>
                </summary>
                {% if request_obj.context_json is not none %}
                  <div class="request-context">
                    <p class="request-context-label">Context</p>
                    <pre>{{ request_obj.context_json | tojson(indent=2) }}</pre>
                  </div>
                {% endif %}
                <form class="inline-response-form" data-request-id="{{ request_obj.request_id }}">
                  <label for="response-{{ request_obj.request_id }}">Response</label>
                  <textarea id="response-{{ request_obj.request_id }}" name="response_text" rows="3" required></textarea>
                  <input name="responder" type="hidden" value="human" />
                  <div class="inline-response-actions">
                    <button type="submit">Send</button>
                    <button type="button" class="button-secondary inline-dismiss-button" data-request-id="{{ request_obj.request_id }}">Dismiss</button>
                    <a href="/requests/{{ request_obj.request_id }}">Details</a>
                  </div>
                  <p class="inline-response-status" aria-live="polite"></p>
                </form>
              </details>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="empty">No pending requests.</p>
      {% endif %}
    </section>
  </div>

  <noscript>
    <p class="noscript-note">JavaScript is disabled. Refresh the page to see updates.</p>
  </noscript>
{% endblock %}
